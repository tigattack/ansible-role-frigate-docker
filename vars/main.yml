---

frigate_docker_ports_configured: >-
  {{
    ([frigate_docker_ports.web_ui.port ~ ':8971'] if frigate_docker_ports.web_ui.expose else []) +
    ([frigate_docker_ports.web_ui_unauth.port ~ ':5000'] if frigate_docker_ports.web_ui_unauth.expose else []) +
    ([frigate_docker_ports.rtsp.port ~ ':8554'] if frigate_docker_ports.rtsp.expose else []) +
    ([frigate_docker_ports.webrtc_tcp.port ~ ':8555/tcp'] if frigate_docker_ports.webrtc_tcp.expose else []) +
    ([frigate_docker_ports.webrtc_udp.port ~ ':8555/udp'] if frigate_docker_ports.webrtc_udp.expose else [])
  }}

frigate_docker_container_mounts_base:
  - type: bind
    read_only: true
    source: /etc/localtime
    target: /etc/localtime
  - type: bind
    read_only: false
    source: "{{ frigate_docker_data_bind_path }}"
    target: /config
  - type: "{{ 'volume' if frigate_docker_storage_use_docker_volume else 'bind' }}"
    target: /media/frigate
    source: "{{ frigate_docker_storage_volume.name if frigate_docker_storage_use_docker_volume else frigate_docker_storage_bind_path }}"
  - type: tmpfs
    target: "{{ frigate_docker_tmpfs_volume.target }}"
    tmpfs_size: "{{ frigate_docker_tmpfs_volume.size }}"

frigate_docker_container_mounts: >-
  {{
    frigate_docker_container_mounts_base +
    frigate_docker_extra_mounts
    if frigate_docker_extra_mounts | length > 0 else
    frigate_docker_container_mounts_base
  }}

# Directories that must exist on the host for bind mounts
frigate_docker_dirs: >-
  {{
    [frigate_docker_data_bind_path] +
    (
      [frigate_docker_storage_bind_path] if not frigate_docker_storage_use_docker_volume
      else []
    )
  }}

# Path to the Frigate config file on the host
frigate_docker_config_path_host: "{{ [frigate_docker_data_bind_path, 'config.yaml'] | path_join }}"

frigate_docker_extra_nvidia:
  device_requests:
    - driver: nvidia
      count: 1
      capabilities: [gpu]

frigate_docker_container_base:
  name: "{{ frigate_docker_container_name }}"
  image: ghcr.io/blakeblackshear/frigate:{{ frigate_docker_version }}
  restart_policy: unless-stopped
  privileged: "{{ frigate_docker_privileged }}"
  capabilities: "{{ frigate_docker_capabilities }}"
  shm_size: "{{ frigate_docker_shm_size }}"
  devices: "{{ frigate_docker_devices }}"
  networks: >-
    {{
      [{'name': frigate_docker_container_network}]
      if frigate_docker_container_network | string | length > 0
      else omit
    }}
  mounts: "{{ frigate_docker_container_mounts }}"
  ports: "{{ frigate_docker_ports_configured }}"
  env: "{{ frigate_docker_env_vars }}"
  state: "{{ frigate_docker_state }}"

frigate_docker_container: >-
  {{
    frigate_docker_container_base | combine(
      frigate_docker_extra_nvidia if frigate_docker_use_nvidia_gpu
      else {}
    )
  }}
